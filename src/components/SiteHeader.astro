---
import { siteConfig } from '@/data/site';

const links = [
  { label: 'About', href: '/#about' },
  { label: 'Projects', href: '/#projects' },
  { label: 'Experience', href: '/#experience' },
  { label: 'Contact', href: '/#contact' },
  { label: 'Blog', href: '/blog/' }
];
---

<header id="site-header" class="site-header sticky top-0 z-30 border-b border-transparent">
  <div class="mx-auto flex w-[min(1080px,92vw)] flex-wrap items-center justify-between gap-4 py-4">
    <a href="/" class="text-sm font-semibold tracking-wide text-slate-100">{siteConfig.name}</a>
    <nav aria-label="Primary">
      <ul class="flex flex-wrap items-center gap-2 text-sm text-muted md:gap-4">
        {
          links.map((link) => (
            <li>
              <a
                class="nav-link rounded-md px-2 py-1 transition hover:text-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent"
                href={link.href}
                data-section-link={link.href.startsWith('/#') ? link.href.slice(2) : undefined}
              >
                {link.label}
              </a>
            </li>
          ))
        }
      </ul>
    </nav>
  </div>
</header>
<script is:inline>
  (() => {
    const init = () => {
      const header = document.getElementById('site-header');
      if (!header) return;

      const trackedLinks = Array.from(header.querySelectorAll('a[data-section-link]'))
        .map((link) => {
          const sectionId = link.getAttribute('data-section-link');
          const section = sectionId ? document.getElementById(sectionId) : null;
          return sectionId && section ? { link, sectionId, section } : null;
        })
        .filter(Boolean);

      const updateHeaderState = () => {
        header.dataset.scrolled = window.scrollY > 12 ? 'true' : 'false';
      };

      const updateActiveLink = () => {
        if (!trackedLinks.length) return;

        const offsetTop = header.getBoundingClientRect().bottom + 12;
        const isAtBottom = window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 2;
        let activeSectionId = isAtBottom ? trackedLinks[trackedLinks.length - 1].sectionId : trackedLinks[0].sectionId;

        if (!isAtBottom) {
          for (let i = trackedLinks.length - 1; i >= 0; i -= 1) {
            const tracked = trackedLinks[i];
            if (tracked.section.getBoundingClientRect().top <= offsetTop) {
              activeSectionId = tracked.sectionId;
              break;
            }
          }
        }

        for (const tracked of trackedLinks) {
          const isCurrent = tracked.sectionId === activeSectionId;
          tracked.link.dataset.current = isCurrent ? 'true' : 'false';
          if (isCurrent) {
            tracked.link.setAttribute('aria-current', 'location');
          } else {
            tracked.link.removeAttribute('aria-current');
          }
        }
      };

      let ticking = false;
      const onScroll = () => {
        if (ticking) return;
        ticking = true;
        window.requestAnimationFrame(() => {
          updateHeaderState();
          updateActiveLink();
          ticking = false;
        });
      };

      updateHeaderState();
      updateActiveLink();
      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onScroll);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  })();
</script>

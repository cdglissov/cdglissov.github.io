---
import { siteConfig } from '@/data/site';

const links = [
  { label: 'About', href: '/#about' },
  { label: 'Projects', href: '/#projects' },
  { label: 'Learning', href: '/#learning' },
  { label: 'Contact', href: '/#contact' },
  { label: 'Blog', href: '/blog/' }
];
const isBlogRoute = Astro.url.pathname === '/blog/' || Astro.url.pathname.startsWith('/blog/');
---

<header id="site-header" class="site-header sticky top-0 z-30 border-b border-transparent">
  <div
    class="site-header-inner mx-auto flex h-14 w-[min(1080px,92vw)] items-center justify-between"
  >
    <a href="/" class="text-sm font-semibold tracking-wide text-slate-100">{siteConfig.name}</a>

    <button
      id="mobile-nav-toggle"
      type="button"
      class="mobile-nav-toggle inline-flex md:hidden"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="mobile-nav-panel"
    >
      <span class="mobile-nav-toggle__bar" aria-hidden="true"></span>
    </button>

    <nav aria-label="Primary" class="hidden md:block">
      <ul class="flex items-center gap-4 text-sm text-muted">
        {
          links.map((link) => {
            const isBlogLink = link.href === '/blog/';
            const isCurrent = isBlogLink && isBlogRoute;

            return (
              <li>
                <a
                  class="nav-link rounded-md px-2 py-1 transition hover:text-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent"
                  href={link.href}
                  aria-current={isCurrent ? 'page' : undefined}
                  data-current={isCurrent ? 'true' : undefined}
                  data-section-link={link.href.startsWith('/#') ? link.href.slice(2) : undefined}
                >
                  {link.label}
                </a>
              </li>
            );
          })
        }
      </ul>
    </nav>

    <nav
      id="mobile-nav-panel"
      aria-label="Primary mobile"
      class="mobile-nav-panel md:hidden"
      data-open="false"
      hidden
    >
      <ul class="grid gap-1 text-sm text-muted">
        {
          links.map((link) => {
            const isBlogLink = link.href === '/blog/';
            const isCurrent = isBlogLink && isBlogRoute;

            return (
              <li>
                <a
                  class="nav-link block w-full rounded-md px-3 py-2 transition hover:text-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent"
                  href={link.href}
                  aria-current={isCurrent ? 'page' : undefined}
                  data-current={isCurrent ? 'true' : undefined}
                  data-section-link={link.href.startsWith('/#') ? link.href.slice(2) : undefined}
                >
                  {link.label}
                </a>
              </li>
            );
          })
        }
      </ul>
    </nav>
  </div>
</header>
<style>
  .site-header {
    background-color: transparent;
    backdrop-filter: blur(0);
    -webkit-backdrop-filter: blur(0);
    transition:
      background-color 240ms ease,
      border-color 240ms ease,
      backdrop-filter 240ms ease,
      -webkit-backdrop-filter 240ms ease,
      box-shadow 240ms ease;
  }

  .site-header-inner {
    position: relative;
  }

  .site-header:is([data-scrolled='true'], [data-mobile-open='true']) {
    background-color: var(--header-scrolled-bg);
    border-color: rgb(255 255 255 / 0.14);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgb(0 0 0 / 0.25);
  }

  .mobile-nav-toggle {
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 0.6rem;
    border: 1px solid rgb(255 255 255 / 0.14);
    background: rgb(255 255 255 / 0.03);
    color: var(--text-main);
  }

  .mobile-nav-toggle:hover,
  .mobile-nav-toggle:focus-visible {
    border-color: var(--accent);
    outline: none;
  }

  .mobile-nav-toggle__bar,
  .mobile-nav-toggle__bar::before,
  .mobile-nav-toggle__bar::after {
    width: 1rem;
    height: 2px;
    border-radius: 999px;
    background: currentColor;
    transition:
      transform 180ms ease,
      opacity 180ms ease,
      background-color 180ms ease;
  }

  .mobile-nav-toggle__bar {
    position: relative;
    display: block;
  }

  .mobile-nav-toggle__bar::before,
  .mobile-nav-toggle__bar::after {
    content: '';
    position: absolute;
    left: 0;
  }

  .mobile-nav-toggle__bar::before {
    top: -0.33rem;
  }

  .mobile-nav-toggle__bar::after {
    top: 0.33rem;
  }

  .mobile-nav-toggle[aria-expanded='true'] .mobile-nav-toggle__bar {
    background-color: transparent;
  }

  .mobile-nav-toggle[aria-expanded='true'] .mobile-nav-toggle__bar::before {
    top: 0;
    transform: rotate(45deg);
  }

  .mobile-nav-toggle[aria-expanded='true'] .mobile-nav-toggle__bar::after {
    top: 0;
    transform: rotate(-45deg);
  }

  .mobile-nav-panel {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    width: min(16rem, 78vw);
    padding: 0.45rem;
    border: 1px solid rgb(255 255 255 / 0.16);
    border-radius: 0.85rem;
    background: rgb(17 20 24 / 0.95);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 16px 34px rgb(0 0 0 / 0.34);
  }

  .mobile-nav-panel[data-open='true'] {
    animation: mobile-nav-in 180ms ease forwards;
  }

  @keyframes mobile-nav-in {
    from {
      opacity: 0;
      transform: translateY(-6px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .nav-link {
    border: 1px solid transparent;
  }

  .nav-link[data-current='true'] {
    color: #edf4fc;
    border-color: rgb(142 164 191 / 0.32);
    background: rgb(142 164 191 / 0.14);
  }

  @media (prefers-reduced-motion: reduce) {
    .mobile-nav-toggle__bar,
    .mobile-nav-toggle__bar::before,
    .mobile-nav-toggle__bar::after {
      transition: none;
    }

    .mobile-nav-panel[data-open='true'] {
      animation: none;
    }
  }
</style>
<script is:inline>
  (() => {
    const init = () => {
      const header = document.getElementById('site-header');
      if (!header) return;
      const mobileToggle = document.getElementById('mobile-nav-toggle');
      const mobilePanel = document.getElementById('mobile-nav-panel');

      const trackedLinks = Array.from(header.querySelectorAll('a[data-section-link]'))
        .map((link) => {
          const sectionId = link.getAttribute('data-section-link');
          const section = sectionId ? document.getElementById(sectionId) : null;
          return sectionId && section ? { link, sectionId, section } : null;
        })
        .filter(Boolean);

      const updateHeaderState = () => {
        header.dataset.scrolled = window.scrollY > 12 ? 'true' : 'false';
      };

      const updateActiveLink = () => {
        if (!trackedLinks.length) return;

        const offsetTop = header.getBoundingClientRect().bottom + 12;
        const isAtBottom =
          window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 2;
        let activeSectionId = isAtBottom
          ? trackedLinks[trackedLinks.length - 1].sectionId
          : trackedLinks[0].sectionId;

        if (!isAtBottom) {
          for (let i = trackedLinks.length - 1; i >= 0; i -= 1) {
            const tracked = trackedLinks[i];
            if (tracked.section.getBoundingClientRect().top <= offsetTop) {
              activeSectionId = tracked.sectionId;
              break;
            }
          }
        }

        for (const tracked of trackedLinks) {
          const isCurrent = tracked.sectionId === activeSectionId;
          tracked.link.dataset.current = isCurrent ? 'true' : 'false';
          if (isCurrent) {
            tracked.link.setAttribute('aria-current', 'location');
          } else {
            tracked.link.removeAttribute('aria-current');
          }
        }
      };

      const setMobileMenuState = (isOpen) => {
        if (!mobileToggle || !mobilePanel) return;

        mobileToggle.setAttribute('aria-expanded', String(isOpen));
        mobilePanel.dataset.open = isOpen ? 'true' : 'false';
        mobilePanel.hidden = !isOpen;
        header.dataset.mobileOpen = isOpen ? 'true' : 'false';
      };

      let ticking = false;
      const onScroll = () => {
        if (ticking) return;
        ticking = true;
        window.requestAnimationFrame(() => {
          updateHeaderState();
          updateActiveLink();
          ticking = false;
        });
      };

      if (mobileToggle && mobilePanel) {
        mobileToggle.addEventListener('click', () => {
          const isOpen = mobileToggle.getAttribute('aria-expanded') === 'true';
          setMobileMenuState(!isOpen);
        });

        mobilePanel.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', () => {
            setMobileMenuState(false);
          });
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            setMobileMenuState(false);
          }
        });

        document.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof Node)) return;
          if (!header.contains(target)) {
            setMobileMenuState(false);
          }
        });

        setMobileMenuState(false);
      }

      updateHeaderState();
      updateActiveLink();
      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', () => {
        if (window.matchMedia('(min-width: 768px)').matches) {
          setMobileMenuState(false);
        }
        onScroll();
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  })();
</script>

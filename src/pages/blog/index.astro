---
import { getCollection } from 'astro:content';
import BlogPostCard from '@/components/BlogPostCard.astro';
import Footer from '@/components/Footer.astro';
import SectionHeading from '@/components/SectionHeading.astro';
import SiteHeader from '@/components/SiteHeader.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { slugifyTag } from '@/utils/format';

const posts = (await getCollection('blog', (entry) => !entry.data.draft)).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const tags = Array.from(new Set(posts.flatMap((post) => post.data.tags))).sort((a, b) =>
  a.localeCompare(b)
);
---

<BaseLayout
  title="Blog | Christian D. Glissov"
  description="Notes and thoughts about anything."
  path="/blog/"
>
  <SiteHeader />
  <main id="content" class="pb-16 pt-10 md:pt-14">
    <section class="section-shell">
      <SectionHeading
        kicker="Blog"
        title="Field Notes & Thoughts"
        subtitle="On just about anything..."
      />
      <div class="mb-4 flex flex-wrap gap-2" data-blog-filters>
        <button class="tag tag-filter" type="button" data-filter-all aria-pressed="true">All</button
        >
        {
          tags.map((tag) => (
            <button
              class="tag tag-filter"
              type="button"
              data-tag={slugifyTag(tag)}
              aria-pressed="false"
            >
              {tag}
            </button>
          ))
        }
      </div>
      <p
        class="mono mb-6 text-xs uppercase tracking-wide text-muted"
        data-filter-status
        aria-live="polite"
      >
        Showing all {posts.length} posts.
      </p>
      <div class="space-y-4">
        {
          posts.map((post) => (
            <BlogPostCard
              post={post}
              data-post-card
              data-post-tags={post.data.tags.map((tag) => slugifyTag(tag)).join(',')}
              data-hidden="false"
            />
          ))
        }
      </div>
    </section>
  </main>
  <Footer />
</BaseLayout>
<style>
  .tag-filter {
    appearance: none;
    cursor: pointer;
    transition:
      border-color 160ms ease,
      color 160ms ease,
      background-color 160ms ease;
    outline: none;
  }

  .tag-filter:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .tag-filter[aria-pressed='true'] {
    border-color: var(--accent);
    background: rgb(142 164 191 / 0.13);
    color: var(--accent);
  }

  [data-post-card][data-hidden='true'] {
    display: none;
  }

  @media (hover: hover) and (pointer: fine) {
    .tag-filter:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
  }
</style>

<script is:inline>
  (() => {
    const filterBar = document.querySelector('[data-blog-filters]');
    const status = document.querySelector('[data-filter-status]');

    if (!filterBar) {
      return;
    }

    const allButton = filterBar.querySelector('[data-filter-all]');
    const tagButtons = Array.from(filterBar.querySelectorAll('[data-tag]'));
    const posts = Array.from(document.querySelectorAll('[data-post-card]'));
    const selectedTags = new Set();
    const isCoarsePointer = window.matchMedia('(pointer: coarse)').matches;

    if (!allButton || posts.length === 0) {
      return;
    }

    const update = () => {
      let visiblePosts = 0;

      posts.forEach((post) => {
        const postTags = (post.getAttribute('data-post-tags') || '').split(',').filter(Boolean);
        const isVisible =
          selectedTags.size === 0 ||
          Array.from(selectedTags).every((tag) => postTags.includes(tag));

        post.setAttribute('data-hidden', isVisible ? 'false' : 'true');

        if (isVisible) {
          visiblePosts += 1;
        }
      });

      allButton.setAttribute('aria-pressed', selectedTags.size === 0 ? 'true' : 'false');

      tagButtons.forEach((button) => {
        const tag = button.getAttribute('data-tag') || '';
        button.setAttribute('aria-pressed', selectedTags.has(tag) ? 'true' : 'false');
      });

      if (!status) {
        return;
      }

      status.textContent =
        selectedTags.size === 0
          ? `Showing all ${posts.length} posts.`
          : `Showing ${visiblePosts} of ${posts.length} posts.`;
    };

    allButton.addEventListener('click', () => {
      selectedTags.clear();
      update();

      if (isCoarsePointer && 'blur' in allButton) {
        allButton.blur();
      }
    });

    tagButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const tag = button.getAttribute('data-tag');

        if (!tag) {
          return;
        }

        if (selectedTags.has(tag)) {
          selectedTags.delete(tag);
        } else {
          selectedTags.add(tag);
        }

        update();

        if (isCoarsePointer && 'blur' in button) {
          button.blur();
        }
      });
    });

    update();
  })();
</script>
